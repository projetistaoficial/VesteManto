<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Veste Manto - Cat√°logo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        /* BLOQUEIO VISUAL PADR√ÉO */
        /* O site come√ßa invis√≠vel e intoc√°vel */
        body {
            opacity: 0 !important;
            pointer-events: none !important;
            background-color: #000 !important;
            transition: opacity 0.3s ease;
        }

        /* Classe que libera o site S√ì SE o JS confirmar que existe */
        body.acesso-liberado {
            opacity: 1 !important;
            pointer-events: auto !important;
            background-color: var(--bg-main, #050505) !important;
        }
    </style>
    <style>
        html,
        body {
            background-color: #000 !important;
            display: none !important;
            /* O site NASCE invis√≠vel */
        }
    </style>

    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function (registrations) {
                for (let registration of registrations) {
                    registration.unregister();
                }
            });
        }
    </script>

</head>


<body class="bg-[var(--bg-main)] text-[var(--txt-body)] text-white font-sans antialiased ">

    <script type="module">
        import { db, doc, getDocFromServer } from './js/firebase-config.js';

        const urlParams = new URLSearchParams(window.location.search);
        const siteId = urlParams.get('site');

        function destruirTudo(motivo) {
            console.error("‚õî ACESSO NEGADO: " + motivo);
            document.body.innerHTML = '';
            // For√ßa o display block APENAS para mostrar a mensagem de erro
            document.body.style.setProperty('display', 'block', 'important');
            document.body.style.backgroundColor = 'black';
            document.body.innerHTML = `
            <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; color:white; font-family:sans-serif; text-align:center; background:black;">
                <h1 style="font-size:5rem; color:#ff4444; margin:0;">404</h1>
                <h2 style="margin:10px 0;">LOJA REMOVIDA</h2>
                <p style="color:#666;">${motivo}</p>
                 <button onclick="window.location.reload()" style="margin-top:20px; padding:10px 20px; cursor:pointer;">Recarregar</button>
            </div>
        `;
            throw new Error("SISTEMA_BLOQUEADO");
        }

        async function validar() {
            console.log("üîç Iniciando Verifica√ß√£o...");

            if (!siteId) {
                // Se for demo/local, libera
                document.body.style.setProperty('display', 'block', 'important');
                import('./js/app.js');
                return;
            }

            try {
                const docRef = doc(db, "sites", siteId);
                const snap = await getDocFromServer(docRef);

                if (!snap.exists()) {
                    destruirTudo("Esta loja foi exclu√≠da permanentemente.");
                    return;
                }

                const data = snap.data();
                if (data.status === 'bloqueado' || data.active === false || data.status === 'excluido') {
                    destruirTudo("A conta desta loja est√° suspensa.");
                    return;
                }

                console.log("‚úÖ Autorizado! Baixando sistema atualizado...");
                window.SITE_ID = siteId;

                // AQUI EST√Å O SEGREDO: O ?v=Date.now()
                await import(`./js/app.js?v=${Date.now()}`);

                // S√ì AGORA MOSTRA O SITE
                document.body.style.setProperty('display', 'block', 'important');

            } catch (e) {
                console.error(e);
                if (e.message !== "SISTEMA_BLOQUEADO") {
                    destruirTudo("Erro de conex√£o.");
                }
            }
        }

        validar();
    </script>


    <script type="module" src="js/firebase-config.js"></script>
    <script type="module" src="js/stats.js"></script>
    <script type="module" src="js/support.js"></script>
</body>

</html>